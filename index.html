<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <title>Dashboard</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#111827" />

  <!-- Base FIRST, then page CSS -->
  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/dashboard.css" />

  <!-- Optional: faster module fetch (safe) -->
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin />
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <h1>Dashboard</h1>

      <!-- Mobile burger -->
      <button
        class="nav-toggle"
        id="navToggle"
        type="button"
        aria-label="Open menu"
        aria-controls="siteNav"
        aria-expanded="false"
      >
        <span class="nav-toggle-bars" aria-hidden="true"></span>
      </button>

      <nav class="nav" id="siteNav" aria-label="Primary navigation" data-collapsible>
        <a class="active" href="index.html" aria-current="page">Dashboard</a>
        <a href="stock-management.html">Stock Management</a>
        <a href="consumable-records.html">Consumables</a>
        <a href="fixture-records.html">Fixtures</a>
        <a href="communications.html">Comms</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <h2>Modules</h2>
      <p class="hint">Open a module like SAP tiles.</p>

      <div class="tiles">
        <a class="tile" href="stock-management.html">
          <div class="tile-title">Stock Management</div>
          <div class="tile-sub">Add items, edit/delete, transfer locations</div>
        </a>

        <a class="tile" href="consumable-records.html">
          <div class="tile-title">Consumable Records</div>
          <div class="tile-sub">View all consumables with inline edit</div>
        </a>

        <a class="tile" href="fixture-records.html">
          <div class="tile-title">Fixture Records</div>
          <div class="tile-sub">View all fixtures with inline edit</div>
        </a>

        <a class="tile" href="communications.html">
          <div class="tile-title">Communications</div>
          <div class="tile-sub">Radio sets status board</div>
        </a>
      </div>
    </section>

    <!-- Alerts -->
    <section class="card">
      <h2>ðŸš¨ Operational Alerts</h2>
      <div id="alertsSummary" class="small">Loading alertsâ€¦</div>
      <div class="alerts-list" id="alertsList"></div>

      <p class="hint">
        Rules: Consumables (Low/Critical/Damaged/Missing), Fixtures (Damaged/Missing), Comms (Spoilt/Decommissioned)
      </p>
    </section>

    <!-- Summary -->
    <section class="card">
      <h2>Summary</h2>
      <div class="summary" id="summary"></div>
      <p class="hint">Data is loaded from Firebase (Firestore).</p>
    </section>
  </main>

  <!-- Wizard / First-time guide -->
  <div id="wizardGate" class="wizard-overlay" hidden>
    <div class="wizard-card" role="dialog" aria-modal="true" aria-label="Quick guide gate">
      <h2>Quick Guide?</h2>
      <p class="small">Is this your first time using the system?</p>

      <div class="wizard-actions">
        <button class="btn primary" id="wizardStartBtn" type="button">Yes, teach me</button>
        <button class="btn" id="wizardSkipBtn" type="button">No, I know</button>
      </div>

      <p class="hint">This will only show once.</p>
    </div>
  </div>

  <div id="wizardStep" class="wizard-overlay" hidden>
    <div class="wizard-card" role="dialog" aria-modal="true" aria-label="Quick guide">
      <div class="wizard-progress" id="wizardProgress"></div>
      <h2 id="wizardTitle"></h2>
      <div class="small" id="wizardText"></div>

      <div class="wizard-actions">
        <button class="btn" id="wizardBackBtn" type="button">Back</button>
        <button class="btn" id="wizardNextBtn" type="button">Next</button>

        <button class="btn" id="wizardActionBtn" type="button" hidden></button>

        <button class="btn primary" id="wizardDoneBtn" type="button" hidden>Done</button>
      </div>

      <button class="wizard-close" id="wizardCloseBtn" type="button" aria-label="Close">âœ•</button>
    </div>
  </div>

  <script type="module" src="js/dashboard.js"></script>

  <!-- Mobile burger toggle (works with base.css nav styles) -->
  <script>
    (function () {
      const btn = document.getElementById("navToggle");
      const nav = document.getElementById("siteNav");
      if (!btn || !nav) return;

      function setOpen(open) {
        btn.setAttribute("aria-expanded", open ? "true" : "false");
        nav.dataset.open = open ? "1" : "0";

        if (open) {
          const first = nav.querySelector("a");
          if (first) first.focus({ preventScroll: true });
        }
      }

      btn.addEventListener("click", () => {
        const isOpen = btn.getAttribute("aria-expanded") === "true";
        setOpen(!isOpen);
      });

      nav.addEventListener("click", (e) => {
        const a = e.target.closest("a");
        if (!a) return;
        setOpen(false);
      });

      document.addEventListener("keydown", (e) => {
        if (e.key !== "Escape") return;
        setOpen(false);
      });

      // Close if switching to desktop width
      const mq = window.matchMedia("(min-width: 721px)");
      mq.addEventListener?.("change", () => setOpen(false));
    })();
  </script>

  <!-- Clean URL helper (Option A â€“ works on Vercel only) -->
  <script>
    (function () {
      const map = {
        "index.html": "/dashboard",
        "stock-management.html": "/stock-management",
        "consumable-records.html": "/consumable-records",
        "fixture-records.html": "/fixture-records",
        "communications.html": "/communications"
      };

      const file = location.pathname.split("/").pop() || "index.html";
      const clean = map[file];
      if (!clean) return;

      const host = location.hostname;
      const isStackBlitz =
        host.includes("stackblitz") ||
        host.includes("webcontainer");

      if (isStackBlitz) return;

      if (location.pathname !== clean) {
        history.replaceState({}, "", clean);
      }
    })();
  </script>
</body>
</html>
